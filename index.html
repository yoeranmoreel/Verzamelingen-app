<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0078d4" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="icon-192.png" />
  <title>ðŸ“¦ Verzamelingen App</title>

  <style>
    :root {
      --primary: #0078d4;
      --bg: #f5f5f5;
      --text: #333;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 1em;
      text-align: center;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 900px;
      margin: auto;
      padding: 1em;
    }

    input, textarea, button, select {
      width: 100%;
      padding: 0.7em;
      margin-top: 0.4em;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover { background: #005fa3; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1em;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1em;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }

    .card:hover { transform: scale(1.02); }

    img {
      width: 100%;
      border-radius: 8px;
    }

    .hidden { display: none; }

    @media (max-width: 600px) {
      header h1 { font-size: 1.4em; }
      main { padding: 0.5em; }
      input, textarea, button { font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“¦ Mijn Verzamelingen</h1>
  </header>

  <main>
    <div id="login-section">
      <h2>Welkom</h2>
      <p>Voer je naam in om te starten:</p>
      <input type="text" id="username" placeholder="Gebruikersnaam" />
      <button onclick="startApp()">Start</button>
    </div>

    <div id="app-section" class="hidden">
      <h2>Verzamelingen</h2>
      <button onclick="showAddCollection()">âž• Nieuwe Verzameling</button>
      <div id="collections" class="grid"></div>

      <div id="add-collection" class="hidden">
        <h3>Nieuwe Verzameling</h3>
        <input id="coll-naam" placeholder="Naam" />
        <textarea id="coll-beschrijving" placeholder="Beschrijving"></textarea>
        <input id="coll-categorie" placeholder="Categorie" />
        <button onclick="saveCollection()">Opslaan</button>
      </div>

      <hr />

      <h2>Items</h2>
      <button onclick="showAddItem()">âž• Nieuw Item</button>
      <div id="items" class="grid"></div>

      <div id="add-item" class="hidden">
        <h3>Nieuw Item</h3>
        <input id="item-titel" placeholder="Titel" />
        <input id="item-auteur" placeholder="Auteur" />
        <input id="item-serie" placeholder="Serie" />
        <input id="item-nummer" placeholder="Nummer" />
        <input id="item-jaar" placeholder="Jaar" />
        <input id="item-uitgever" placeholder="Uitgever" />
        <input id="item-genre" placeholder="Genre" />
        <input id="item-staat" placeholder="Staat / conditie" />
        <input id="item-prijs" placeholder="Prijs" />
        <input id="item-foto" type="file" accept="image/*" />
        <button onclick="saveItem()">Opslaan</button>
      </div>
    </div>
  </main>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpVuncxa3rxqPex1JXAuc1HBjuqZHEGknwuBzmf5v69B5ZRqqpDxorBA5hm3c95YY1/exec";
    const SHEET_ID = "1ZfoFJp-J_9zgfJ7NaBfDFVrhOdP7nfOzM-zMJZTucWA";
    let currentUser = "";
    let selectedCollectionId = "";

    async function startApp() {
      currentUser = document.getElementById("username").value.trim();
      if (!currentUser) return alert("Voer een gebruikersnaam in.");
      document.getElementById("login-section").classList.add("hidden");
      document.getElementById("app-section").classList.remove("hidden");
      loadCollections();
      loadItems();
    }

    function showAddCollection() {
      document.getElementById("add-collection").classList.toggle("hidden");
    }

    function showAddItem() {
      document.getElementById("add-item").classList.toggle("hidden");
    }

    async function saveCollection() {
      const naam = document.getElementById("coll-naam").value;
      const beschrijving = document.getElementById("coll-beschrijving").value;
      const categorie = document.getElementById("coll-categorie").value;
      if (!naam) return alert("Naam is verplicht.");

      const values = [[
        "ID-" + Date.now(),
        currentUser,
        naam,
        beschrijving,
        categorie,
        new Date().toLocaleString("nl-NL")
      ]];

      await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sheet: "Verzamelingen", values })
      });

      loadCollections();
      alert("Verzameling toegevoegd!");
      document.getElementById("add-collection").classList.add("hidden");
    }

    async function saveItem() {
      const titel = document.getElementById("item-titel").value;
      if (!titel) return alert("Titel is verplicht.");
      const fotoFile = document.getElementById("item-foto").files[0];
      let fotoUrl = "";
      if (fotoFile) fotoUrl = await uploadPhoto(fotoFile);

      const values = [[
        "ID-" + Date.now(),
        currentUser,
        selectedCollectionId || "",
        titel,
        document.getElementById("item-auteur").value,
        document.getElementById("item-serie").value,
        document.getElementById("item-nummer").value,
        document.getElementById("item-jaar").value,
        document.getElementById("item-uitgever").value,
        "",
        "",
        document.getElementById("item-genre").value,
        document.getElementById("item-staat").value,
        document.getElementById("item-prijs").value,
        new Date().toLocaleString("nl-NL"),
        "",
        fotoUrl,
        ""
      ]];

      await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sheet: "Items", values })
      });

      loadItems();
      alert("Item toegevoegd!");
      document.getElementById("add-item").classList.add("hidden");
    }

    async function uploadPhoto(file) {
      const reader = new FileReader();
      return new Promise((resolve) => {
        reader.onload = async (e) => {
          const base64Data = e.target.result;
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "uploadPhoto",
              fileName: file.name,
              mimeType: file.type,
              imageData: base64Data
            })
          });
          const result = await response.json();
          if (result.success) resolve(result.url);
          else resolve("");
        };
        reader.readAsDataURL(file);
      });
    }

    async function loadCollections() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Verzamelingen`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const data = json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
      const list = document.getElementById("collections");
      list.innerHTML = "";
      data.forEach(r => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<h3>${r[2]}</h3><p>${r[3]}</p><small>${r[4]}</small>`;
        div.onclick = () => { selectedCollectionId = r[0]; loadItems(); };
        list.appendChild(div);
      });
    }

    async function loadItems() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Items`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const data = json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
      const list = document.getElementById("items");
      list.innerHTML = "";
      data.filter(r => !selectedCollectionId || r[2] === selectedCollectionId).forEach(r => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          ${r[16] ? `<img src="${r[16]}" alt="foto">` : ""}
          <h3>${r[3]}</h3>
          <p>${r[4] || ""}</p>
          <small>${r[14] || ""}</small>
        `;
        list.appendChild(div);
      });
    }

    // âœ… PWA service worker registreren
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker geregistreerd.'))
        .catch(err => console.error('SW fout:', err));
    }
  </script>
</body>
</html>
